function e(){return e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},e.apply(this,arguments)}function t(e,t){if(null==e)return{};var r,n,o={},s=Object.keys(e);for(n=0;n<s.length;n++)t.indexOf(r=s[n])>=0||(o[r]=e[r]);return o}const r=e=>null==e,n=e=>"boolean"==typeof e,o=e=>!r(e)&&e instanceof HTMLElement,s=e=>!r(e)&&e instanceof Error,a=e=>"function"==typeof e,c=e=>!r(e)&&e instanceof Map,i=e=>!r(e)&&"object"==typeof e,l=e=>!r(e)&&e instanceof Promise,d=e=>"string"==typeof e,u=e=>!r(e)&&e instanceof WeakMap,g=e=>Array.isArray(e)?e:[e],v=(e,t)=>Object.defineProperty(i(e)?e:{},"context",{enumerable:!0,value:t}),m=e=>i(e)&&d(e.context.id)&&e.context.id.length,p=(e,t)=>null!=e&&e||null!=t&&t;var f={createTag:function(e,t,r){const n=document.createElement(e);return r&&(r instanceof HTMLElement||r instanceof SVGElement||r instanceof DocumentFragment?n.append(r):Array.isArray(r)?n.append(...r):n.insertAdjacentHTML("beforeend",r)),t&&Object.entries(t).forEach(([e,t])=>{n.setAttribute(e,t)}),n},getMatchingSelfOrAncestor:(e,t)=>e.matches(t)?e:e.closest(t),hasContext:m,isBoolean:n,isHTMLElement:o,isError:s,isFunction:a,isNil:r,isObject:i,isPromise:l,isString:d,setContext:v,toArray:g,toBoolean:e=>n(e)?e:["1","true"].includes(String(e))};const b={},h=()=>{const e=new Map;return{getOrSet(t,r){t=Array.isArray(t)?t:[t];const{length:n}=t;let o=e;for(let e=0;e<n-1;e+=1){const r=t[e];if(o.has(r)){const e=o.get(r);c(e)||o.set(r,new Map([[b,e]]))}else o.set(r,new Map);o=o.get(r)}const s=t[n-1];if(o.has(s)){const e=o.get(s);return c(e)?e.get(b):e}const a=r();if(c(a))throw new Error("Map object cannot be cached");return o.set(s,a),a}}},w=()=>{const e=new Map;return{getOrSet(t,r){t=Array.isArray(t)?t:[t];const{length:n}=t;let o=e;for(let e=0;e<n-1;e+=1){const r=t[e];if(o.has(r)){const e=o.get(r);u(e)||o.set(r,new WeakMap([[b,e]]))}else o.set(r,new WeakMap);o=o.get(r)}const s=t[n-1];if(o.has(s)){const e=o.get(s);return u(e)?e.get(b):e}const a=r();if(u(a))throw new Error("WeakMap object cannot be cached");return o.set(s,a),a}}},x="taco",E=(...e)=>[x,...e].join("-"),y={stale:"stale",pending:"pending",rejected:"rejected",resolved:"resolved"},j=e({},y,{disabled:"disabled",extracted:"extracted",observed:"observed",provided:"provided",presented:"presented"}),A={stale:E(j.pending),observed:E(j.observed),pending:E(j.pending),extracted:E(j.extracted),provided:E(j.provided),rejected:E(j.rejected),resolved:E(j.resolved),presented:E(j.presented)},M={disabled:E(j.disabled),stale:A.stale,pending:A.pending,rejected:A.resolved,resolved:A.rejected};var O={CssClass:M,Event:A,Stage:y,namespace:x};const L=Date.now(),S=new Map,P=new Set,T=new Set,k=Object.freeze({debug:"debug",error:"error",info:"info",warn:"warn"}),D=(e,t,r,n,o)=>({instance:e,level:t,message:r,namespace:n,params:o,timestamp:Date.now()-L});function N(e,...t){C.consoleWriter.writer(D(C.level.error,e,O.namespace,t))}function C(e){var t;const r=(null!=(t=S.get(e))?t:0)+1;S.set(e,r);const n=t=>(n,...o)=>{return s=D(r,t,n,e,o),void([...P].every(e=>{try{return e(s)}catch(t){return N("Log filter error:",{record:s,filter:e}),!0}})&&T.forEach(e=>{try{e(s)}catch(t){N("Log writer error:",{record:s,writer:e})}}));var s};return Object.seal({id:`${e}-${r}`,namespace:e,module:t=>C(`${e}/${t}`),debug:n(k.debug),error:n(k.error),info:n(k.info),warn:n(k.warn),[Symbol.toStringTag]:"Log"})}C.level=k,C.debugFilter={filter:({level:e})=>e!==k.debug},C.quietFilter={filter:()=>!1},C.consoleWriter={writer({instance:e,level:t,message:r,namespace:n,params:o,timestamp:s}){console[t](`[${n}] #${e}`,r,...o,`(+${s}ms)`)}},C.isLog=e=>null!=e&&"Log"===e[Symbol.toStringTag],C.reset=e=>{P.clear(),T.clear(),C.use(C.consoleWriter)},C.use=(...e)=>(e.forEach(e=>{const{filter:t,writer:r}=e;a(t)?P.add(t):a(r)?T.add(r):C.common.warn("Unknown log module:",{module:e})}),C),C.common=C(O.namespace),C.reset();const W=e=>{var t;return C.isLog(e)?e:null!=(t=C.common)?t:console};function $(e,t,r){try{return r()}catch(r){return void W(e).error(t,r)}}const F=["id"],U=["id"],H=e=>(r,n)=>{const o=C.common.module("extract");n.listen(A.observed,async({detail:{context:s,element:a}},c)=>{const{id:l}=s,d=t(s,F);if(await function(e,t,r,n){const o=(t,s)=>!s||t>=r.length?Promise.resolve(!!s):function(e,t,r){const n=t=>(W(e).error("Extractor function error:",t),Promise.resolve(void 0));try{return Promise.resolve(r()).catch(n)}catch(e){return n(e)}}(e,0,()=>n(r[t])).then(e=>o(t+1,e),()=>Promise.resolve(!1));return o(0,!0)}(o,0,e,async e=>{var t;if(null!=(t=r.signal)&&t.aborted)return!1;const n=await e(s,a,c,r);return i(n)?(Object.assign(s,n),!0):(o.debug("Extractor function returned not object, ignoring placeholder:",{context:s,element:a,event:c}),!1)})){const e=t(s,U);JSON.stringify(e)!==JSON.stringify(d)&&(s.id=l,n.extract(s),o.debug("Extracted:",{context:s,element:a,event:c}))}}),r.dispose(()=>o.debug("Aborted")),o.debug("Activated:",{extractors:e})};class I extends CustomEvent{constructor(e,t,{context:r,element:n,result:o,stage:s}){super(t,{bubbles:e,detail:{context:r,element:n,result:o,stage:s}})}}const q=new WeakMap,z=["attributes","characterData","childList"],B=Object.values(M);function J(e,t){B.forEach(t=>{e.classList.remove(t)}),e.classList.add(M[t]),e.classList.toggle(M.disabled,t!==y.resolved)}const _=e=>(t,r)=>{const n=C.common.module("present");r.listen([A.observed,A.extracted,A.provided],({detail:{context:s,element:a,result:c,stage:i}},l)=>{const d=e[i];let u=a;var g;null!=d&&d.length?(u=null!=(g=d.reduce((e,r)=>$(n,"Presenter callback error:",()=>{const n=r(e,null!=c?c:{context:s},l,t);return o(n)?n:e}),a))?g:a,J(u,i),r.present(s,u),n.debug("Presented:",{context:s,element:a,event:l,result:c,stage:i})):(J(u,i),n.debug("No presenters, ignoring result:",{context:s,element:a,event:l,result:c,stage:i}))}),t.dispose(()=>n.debug("Aborted")),n.debug("Activated:",{presenters:e})};class G extends Error{}function V(e){const t=new Map;let n;return(o,s)=>{const a=C.common.module("provide");function c(e,t,n){r(n)||(Array.isArray(n)?n.forEach(r=>c(e,t,r)):l(n)?t.push(n.then(r=>c(e,t,r),r=>c(e,t,r))):m(n)&&(e.has(n.context.id)?(e.delete(n.context.id),a.debug("Provided:",n),s.provide(n)):a.warn("Unexpected result, ignoring:",n)))}async function i(){var r;if(null!=(r=o.signal)&&r.aborted)return;n=0;const s=new Map(t.entries());t.clear();const i=[];for($(a,"Provider callback error:",()=>c(s,i,e([...s.values()],o.signal)));0<i.length;)await i[0].catch(()=>{});c(s,[],[...s.values()].map(e=>(e=>v(new G("Not provided"),e))(e)))}s.listen(A.extracted,({detail:{context:e}})=>{t.set(e.id,e),n||(n=setTimeout(i,1))}),o.dispose(()=>a.debug("Aborted")),a.debug("Activated:",{provider:e})}}function K(t,n,c,l,d={pending:[],rejected:[],resolved:[]}){function u(r,o){if(a(o))return K(t,n,c,l,e({},d,{[r]:[...d[r],o]}));throw new Error("Presenter must be a function")}return{observe(u=document.body,v=null,m=null){if(!(u instanceof Element))throw new Error("Scope must be a DOM Element");const f=((...e)=>({events:[...new Set(e.flatMap(({events:e}={})=>e).filter(e=>e))],mutations:e.map(({mutations:e}={})=>e).filter(e=>i(e)).reduce((e,{attributeFilter:t,attributes:r,characterData:n,childList:o,subtree:s}={})=>{var a;return t&&(e.attributeFilter=(null!=(a=e.attributeFilter)?a:[]).concat(t)),e.attributes=p(e.attributes,r),e.characterData=p(e.characterData,n),e.childList=p(e.childList,o),e.subtree=p(e.subtree,s),e},{}),triggers:e.map(({trigger:e}={})=>e).filter(a)}))(...l,v);return function(t,n,c,l,d,u){var v;const m=C.common.module("observe");if(null!=(v=t.signal)&&v.aborted)return{get placeholders(){return[]}};const p=function(t,r,n,a){const c=new WeakMap,l=C.common.module("cycle");let d=0;const u=new Map;function v(e,t,n){const o=new I(e,t,n);n.event&&c.set(o,n.event),(e?n.element:r).dispatchEvent(o)}return{get placeholders(){return[...u.values()]},get scope(){return r},get selector(){return n},dispose(e){var r,n;u.delete(null==(r=u.get(e))||null==(n=r.context)?void 0:n.id),u.delete(e),t.release(e)},exists:e=>u.has(e),extract(e){const t=u.get(e.id);t?(t.context=e,l.debug("Extracted:",t),v(!0,A.pending,t),v(!1,A.extracted,t)):l.warn("Extracted context is unexpected:",{context:e})},listen(e,n,o={}){const s=e=>n(e,c.get(e));g(e).forEach(e=>{r.addEventListener(e,s,o),t.dispose(()=>r.removeEventListener(e,s))})},match(e){const t=o(e)?e:e.parentElement;if(t){if(t.matches(n)&&a(t))return t;const e=t.closest(n);if(o(e)&&(null==e?void 0:e.compareDocumentPosition(r))===Node.DOCUMENT_POSITION_CONTAINS&&a(e))return e}},observe(t,r,n){let o=u.get(t);o?o.stage=y.pending:(o={context:null,element:t,event:n,result:null,stage:y.pending},u.set(r.id,o),u.set(t,o)),o.context=e({},i(r)?e({},r):{},{id:`${++d}-${Date.now()}`}),v(!0,A.stale,o),v(!1,A.observed,o)},present(e,t){const r=u.get(e.id);r&&(r.element=t,v(!0,r.stage===y.rejected?A.rejected:A.resolved,r))},provide(e){const t=u.get(e.context.id);t?(t.context=e.context,t.result=e,t.stage=s(e)?y.rejected:y.resolved,v(!1,A.provided,t)):l.warn("Provided result is unexpected, ignoring:",e)},select:()=>[...r.querySelectorAll(n)].filter(a)}}(t,l,d,u),f=new Set,b=new Set;let h;function w(){h||(h=setTimeout(function(){var e;null!=(e=t.signal)&&e.aborted||(h=0,f.forEach(({element:e})=>{!function(e){p.dispose(e),m.debug("Unmounted:",{element:e})}(e)}),b.forEach(({element:e,event:o})=>{!function(e,o){p.exists(e)||(m.debug("Mounting:",{element:e}),n.events.forEach(r=>{e.addEventListener(r,o,{signal:t.signal})}),n.triggers.forEach(n=>{const s=$(m,"Trigger function error:",()=>n(e,o,t));a(s)?t.dispose(s,e):r(s)||m.warn("Trigger must return a function:",{result:s,trigger:n})}))}(e,t=>{b.add({element:e,event:t}),w()}),m.debug("Observed:",{element:e,event:o}),p.observe(e,void 0,o)}))},0))}function x(e){e&&(f.delete(e),b.add({element:e})),w()}if(c.forEach(e=>{e(t,p)}),p.select().forEach(x),z.some(e=>n.mutations[e])){const e=new MutationObserver(e=>e.forEach(e=>{if("childList"===e.type){const{addedNodes:t,removedNodes:r}=e;r.forEach(e=>{return(t=p.match(e))&&(f.add({element:t}),b.delete(t)),void w();var t}),t.forEach(e=>x(p.match(e)))}else x(p.match(e.target))}));e.observe(l,n.mutations),t.dispose(()=>e.disconnect()),m.debug("Observing:",{scope:l,selector:d})}return t.dispose(()=>m.debug("Aborted")),m.debug("Activated:",{reactions:n,scope:l,selector:d}),(e=>({get placeholders(){return e.placeholders.map(t=>function(e,t){return q.has(t)||q.set(t,{get context(){return t.context},get element(){return t.element},get event(){return t.event},get result(){return t.result},get stage(){return t.stage},get promise(){return new Promise((e,r)=>{switch(t.stage){case y.resolved:e(t.result);break;case y.rejected:r(t.result)}})},update(r={}){e.observe(t.element,r)}}),q.get(t)}(e,t))}}))(p)}(function(e){const t=C.common.module("control");function n(e){null==e||e.forEach(e=>$(t,"Disposer callback error:",e))}const o=new Map;return null==e||e.addEventListener("abort",()=>{var r,s;t.debug("Aborted:",null!=(r=null==(s=e.reason)?void 0:s.message)?r:e.reason),n([...o.values()].flat())},{once:!0}),t.debug("Activated:",{signal:e}),{dispose(t,r=null){const s=Array.isArray(t)?t.flat(3):[t];return null!=e&&e.aborted?(n(s),!0):(o.has(r)||o.set(r,[]),o.set(r,[...s,...o.get(r)]),!1)},release(e){r(e)||n(o.get(e))},signal:e}}(m),f,[...c,_(d)],u,t,n)},pending:e=>u(y.pending,e),rejected:e=>u(y.rejected,e),resolved:e=>u(y.resolved,e),stale:e=>u(y.pending,e)}}function Q(e,t,r=[],n=[]){return{extract(o,s){if(!a(o))throw new Error("Extractor must be a function");return Q(e,t,[...r,o],[...n,s])},provide(o){if(!a(o))throw new Error("Provider must be a function");const s={[y.pending]:[],[y.pending]:[],[y.rejected]:[],[y.resolved]:[]};return K(e,t,[H(r),V(o)],n,s)}}}const R=Object.freeze({select:(e,t)=>Q(e,null!=t?t:()=>!0),CssClass:M,Event:A,Log:C,namespace:x,Stage:y});export{h as Cache,O as Constant,f as Util,w as WeakCache,R as default};
